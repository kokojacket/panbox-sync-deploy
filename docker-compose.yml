version: '3.8'

services:
  panbox-sync:
    image: kokojacket/panbox-sync:latest
    container_name: panbox-sync
    ports:
      - "${BACKEND_PORT:-8000}:8000"
      # 可选：暴露内置 OpenList 端口（仅当 ENABLE_INTERNAL_OPENLIST=true 时需要）
      # 格式：宿主机端口:容器内端口（容器内固定使用 5244）
      - "${OPENLIST_PORT:-5244}:5244"
    volumes:
      # 挂载整个数据目录（包含数据库、下载、日志、上传文件）
      # 对应 backend/app/config.py 中的 DATA_DIR = /app/backend/data
      - ./data:/app/backend/data
      # 挂载 Docker socket 用于容器管理（重启 OpenList）
      # 注意：需要宿主机 docker 组权限，通过 group_add 或 chmod 666 解决
      - /var/run/docker.sock:/var/run/docker.sock
      # 挂载内置 OpenList 数据目录（仅当 ENABLE_INTERNAL_OPENLIST=true 时使用）
      - ./openlist-data:/app/openlist-data
    # 添加 docker 组权限（自动检测，通过 .env 文件配置）
    # 查看宿主机 GID: getent group docker
    group_add:
      - "${DOCKER_GID:-999}"  # 从 .env 读取，默认 999
    environment:
      # 生产模式（禁用自动重载以提升性能和稳定性）
      - ENVIRONMENT=production
      # 时区
      - TZ=${TZ:-Asia/Shanghai}
      # ========== 内置 OpenList 配置 ==========
      # 设为 "true" 启用内置 OpenList（一体化模式，推荐）
      # 设为 "false" 使用外部 OpenList 容器
      - ENABLE_INTERNAL_OPENLIST=${ENABLE_INTERNAL_OPENLIST:-true}
      # 内置 OpenList 数据目录（仅当 ENABLE_INTERNAL_OPENLIST=true 时使用）
      - INTERNAL_OPENLIST_DATA=/app/openlist-data
      # ========== 外部 OpenList 配置 ==========
      # OpenList 容器名称，用于重启功能（仅当 ENABLE_INTERNAL_OPENLIST=false 时使用）
      - OPENLIST_CONTAINER_NAME=${OPENLIST_CONTAINER_NAME:-openlist}
      # 可选：覆盖默认设置
      # - LOG_LEVEL=INFO
      # - MAX_CONCURRENT_DOWNLOADS=3
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; import sys; (lambda: (urllib.request.urlopen('http://localhost:8000/api/health', timeout=5).read(), sys.exit(0)) if True else sys.exit(1))() if __name__ == '__main__' else None"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

# 可选：添加网络配置
# networks:
#   default:
#     name: panbox-sync-network
